<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åœ‹æ³°ä¸–è¯CUBEå¡LINE PAYå›é¥‹è¨ˆç®—å™¨</title>
    
    <!-- React & Tailwind -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDK -->
    <script type="importmap">
      {
        "imports": {
          "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
          "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
          "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
        }
      }
    </script>

    <style>
        body { 
            background-color: #f1f5f9;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            min-height: 100vh;
            color: #334155;
            padding-bottom: 100px;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            border-radius: 1.5rem;
        }

        .app-card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border-radius: 1.5rem;
        }

        .btn-touch { transition: all 0.1s ease-in-out; }
        .btn-touch:active { transform: scale(0.96); filter: brightness(0.95); }

        .btn-primary {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            box-shadow: 0 4px 6px rgba(5, 150, 105, 0.2);
        }
        .btn-primary:active { box-shadow: 0 2px 4px rgba(5, 150, 105, 0.2); }

        .custom-input {
            border: 2px solid #f1f5f9;
            background: #f8fafc;
            transition: all 0.2s;
            appearance: none; 
            color: #334155;
        }
        .custom-input:focus {
            background: #fff;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
            outline: none;
        }

        /* Modal Animations */
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes modalOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        
        .modal-enter { animation: modalIn 0.2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        .modal-exit { animation: modalOut 0.2s cubic-bezier(0.4, 0, 0.2, 1) forwards; }

        /* Dropdown Animation */
        @keyframes dropIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .dropdown-anim { animation: dropIn 0.2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }

        /* Toast Animation */
        @keyframes toastUp { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }
        .toast-anim { animation: toastUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }

        .loading-spinner { border: 3px solid #e2e8f0; border-top: 3px solid #10b981; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .badge { display: inline-flex; align-items: center; padding: 3px 10px; border-radius: 999px; font-size: 0.7rem; font-weight: 700; letter-spacing: 0.02em; }
        .badge-base { background: #f1f5f9; color: #64748b; }
        .badge-bonus { background: #dcfce7; color: #15803d; } 
        .badge-capped { background: #fee2e2; color: #b91c1c; }
        .badge-excluded { background: #f1f5f9; color: #94a3b8; text-decoration: line-through; }
        .badge-warning { background: #ffedd5; color: #c2410c; }

        /* Hide Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel" data-type="module" data-presets="react">
    import { initializeApp } from 'firebase/app';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, deleteUser, updateProfile, updatePassword, EmailAuthProvider, reauthenticateWithCredential } from 'firebase/auth';
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc, getDocs, setDoc, updateDoc } from 'firebase/firestore';
    
    // ==========================================================
    // ğŸ”¥ è«‹åœ¨æ­¤è™•å¡«å…¥ä½ çš„ Firebase Config
    // ==========================================================
    const firebaseConfig = {
        apiKey: "AIzaSyCZI5fxjjrsoKgUBIVU5s1YqvAYdn_CL88",
        authDomain: "cub-linepay.firebaseapp.com",
        projectId: "cub-linepay",
        storageBucket: "cub-linepay.firebasestorage.app",
        messagingSenderId: "469367852222",
        appId: "1:469367852222:web:9f3a855dd501849d57a2ef"
    };
    // ==========================================================

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const { useState, useEffect, useRef } = React;

    // æ¶ˆè²»é¡åˆ¥å®šç¾© (ä½¿ç”¨ Font Awesome class)
    const CATEGORIES = [
        { id: 'general', name: 'ä¸€èˆ¬æ¶ˆè²»', icon: 'fa-solid fa-cart-shopping', noBonus: false, noBase: false },
        { id: 'dining', name: 'é¤é£²ç¾é£Ÿ', icon: 'fa-solid fa-utensils', noBonus: false, noBase: false },
        { id: 'transport', name: 'äº¤é€šé‹è¼¸', icon: 'fa-solid fa-train-subway', noBonus: false, noBase: false },
        { id: 'online', name: 'ç¶²è³¼é›»å•†', icon: 'fa-solid fa-globe', noBonus: false, noBase: false },
        { id: 'market', name: 'è¶…å¸‚é‡è²©', icon: 'fa-solid fa-basket-shopping', noBonus: false, noBase: false },
        { id: 'cvs', name: 'ä¾¿åˆ©å•†åº—', icon: 'fa-solid fa-store', noBonus: false, noBase: false },
        { id: 'fun', name: 'å¨›æ¨‚ä¼‘é–’', icon: 'fa-solid fa-gamepad', noBonus: false, noBase: false },
        { id: 'gas', name: 'åŠ æ²¹åœè»Š', icon: 'fa-solid fa-gas-pump', noBonus: false, noBase: false },
        { id: 'medical', name: 'é†«ç™‚ä¿å¥', icon: 'fa-solid fa-notes-medical', noBonus: false, noBase: false },
        { id: 'edu', name: 'æ•™è‚²å­¸ç¿’', icon: 'fa-solid fa-graduation-cap', noBonus: false, noBase: false },
        // ç„¡åŠ ç¢¼ (1.7%) ä½†æœ‰åŸºæœ¬ (0.3%)
        { id: 'dept', name: 'ç™¾è²¨è³¼ç‰©', icon: 'fa-solid fa-bag-shopping', noBonus: true, noBase: false },
        { id: 'foodcourt', name: 'ç¾é£Ÿè¡—', icon: 'fa-solid fa-bowl-food', noBonus: true, noBase: false },
        { id: 'delivery', name: 'å¤–é€å¹³å°', icon: 'fa-solid fa-motorcycle', noBonus: true, noBase: false },
        { id: 'overseas', name: 'æµ·å¤–æ¶ˆè²»', icon: 'fa-solid fa-plane', noBonus: true, noBase: false },
        // å®Œå…¨æ’é™¤ (ç„¡0.3% ä¹Ÿç„¡ 1.7%)
        { id: 'bill', name: 'ç¹³è²»/ç¨…', icon: 'fa-solid fa-file-invoice-dollar', noBonus: true, noBase: true },
    ];

    // --- Toast çµ„ä»¶ (æˆåŠŸæç¤ºæ¡†) ---
    const Toast = ({ show, message }) => {
        if (!show) return null;
        return (
            <div className="fixed bottom-10 left-1/2 -translate-x-1/2 z-[200] toast-anim pointer-events-none">
                <div className="bg-emerald-600 text-white px-6 py-3 rounded-full shadow-lg shadow-emerald-200 flex items-center gap-2 font-bold text-sm">
                    <i className="fa-solid fa-check"></i>
                    <span>{message}</span>
                </div>
            </div>
        );
    };

    // --- é€šç”¨ Modal çµ„ä»¶ ---
    const Modal = ({ isOpen, title, content, type = 'info', isDanger = false, onConfirm, onCancel, confirmText = 'ç¢ºå®š', cancelText = 'å–æ¶ˆ', inputPlaceholder, inputValue: initialInputValue, editingData, enableDelay = false }) => {
        const [isVisible, setIsVisible] = useState(false);
        const [isClosing, setIsClosing] = useState(false);
        const [val, setVal] = useState('');
        const [val2, setVal2] = useState('');
        const [processing, setProcessing] = useState(false);
        const [showPin, setShowPin] = useState(false);

        const [editForm, setEditForm] = useState({ 
            date: new Date().toISOString().substring(0, 10), 
            merchant: '', 
            amount: '', 
            category: 'general',
            excluded: false,  
            noBonus: false    
        });

        useEffect(() => {
            if (isOpen) {
                setIsVisible(true);
                setIsClosing(false);
                setVal(initialInputValue || '');
                setVal2('');
                setProcessing(false);
                setShowPin(false);
                if (editingData) {
                    setEditForm({ 
                        date: editingData.date, 
                        merchant: editingData.merchant, 
                        amount: editingData.amount, 
                        category: editingData.category || 'general',
                        excluded: editingData.excluded || false,
                        noBonus: editingData.noBonus || false
                    });
                } else {
                     setEditForm({ 
                        date: new Date().toISOString().substring(0, 10), 
                        merchant: '', 
                        amount: '', 
                        category: 'general',
                        excluded: false,
                        noBonus: false
                    });
                }
            } else {
                setIsClosing(true);
                const timer = setTimeout(() => setIsVisible(false), 200);
                return () => clearTimeout(timer);
            }
        }, [isOpen, initialInputValue, editingData]);

        // è™•ç†é¡åˆ¥è®Šæ›´ï¼Œè‡ªå‹•è¨­å®šæ’é™¤è¦å‰‡
        const handleCategoryChange = (catId) => {
            const cat = CATEGORIES.find(c => c.id === catId);
            if (cat) {
                setEditForm(prev => ({
                    ...prev,
                    category: catId,
                    excluded: cat.noBase,
                    noBonus: cat.noBonus
                }));
            }
        };

        if (!isVisible) return null;

        const handleConfirm = async () => {
            if (processing) return;
            setProcessing(true);
            if (enableDelay) await new Promise(resolve => setTimeout(resolve, 600));
            try {
                if (type === 'input') await onConfirm(val);
                else if (type === 'changePin') await onConfirm(val, val2);
                else if (type === 'editTransaction' || type === 'addTransaction') await onConfirm(editForm);
                else await onConfirm();
            } catch(e) { console.error(e); }
            setProcessing(false);
        };
        
        const renderContent = () => {
            return (
                <div className="space-y-4">
                    {content && <div className="text-gray-600 leading-relaxed">{content}</div>}
                    {type === 'input' && <input type="text" className="custom-input w-full p-3 rounded-xl text-lg font-bold text-gray-800" placeholder={inputPlaceholder} value={val} onChange={e => setVal(e.target.value)} autoFocus />}
                    {type === 'changePin' && (
                        <div className="space-y-3 relative">
                            <div><label className="text-xs font-bold text-gray-500">èˆŠ PIN ç¢¼</label><input type={showPin ? "tel" : "password"} maxLength="6" className="custom-input w-full p-2.5 rounded-xl text-center text-lg font-mono tracking-widest" value={val} onChange={e => setVal(e.target.value.replace(/\D/g, ''))} /></div>
                            <div><label className="text-xs font-bold text-gray-500">æ–° PIN ç¢¼</label><input type={showPin ? "tel" : "password"} maxLength="6" className="custom-input w-full p-2.5 rounded-xl text-center text-lg font-mono tracking-widest" value={val2} onChange={e => setVal2(e.target.value.replace(/\D/g, ''))} /></div>
                            <button type="button" onClick={() => setShowPin(!showPin)} className="absolute right-0 top-6 text-gray-400 hover:text-emerald-600 w-10 h-10 flex items-center justify-center transition-colors rounded-full active:bg-gray-100">
                                <i className={`fa-regular ${showPin ? 'fa-eye-slash' : 'fa-eye'}`}></i>
                            </button>
                        </div>
                    )}
                    {(type === 'editTransaction' || type === 'addTransaction') && (
                        <div className="space-y-3">
                            <div><label className="text-xs font-bold text-gray-500">æ—¥æœŸ</label><input type="date" className="custom-input w-full p-2.5 rounded-xl" value={editForm.date} onChange={e => setEditForm({ ...editForm, date: e.target.value })} /></div>
                            <div>
                                <label className="text-xs font-bold text-gray-500">æ¶ˆè²»é¡åˆ¥</label>
                                <div className="relative">
                                    <select className="custom-input w-full p-2.5 rounded-xl appearance-none" value={editForm.category} onChange={e => handleCategoryChange(e.target.value)}>
                                        {CATEGORIES.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                    </select>
                                    <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400">
                                        <i className="fa-solid fa-chevron-down text-xs"></i>
                                    </div>
                                </div>
                            </div>
                            <div><label className="text-xs font-bold text-gray-500">å•†å®¶</label><input type="text" className="custom-input w-full p-2.5 rounded-xl" placeholder="å•†å®¶åç¨±" value={editForm.merchant} onChange={e => setEditForm({ ...editForm, merchant: e.target.value })} /></div>
                            <div><label className="text-xs font-bold text-gray-500">é‡‘é¡</label><input type="number" className="custom-input w-full p-2.5 rounded-xl" placeholder="$" value={editForm.amount} onChange={e => setEditForm({ ...editForm, amount: parseInt(e.target.value) || '' })} /></div>
                            
                            <div className="flex gap-2 text-xs font-bold mt-2 justify-end">
                                {editForm.excluded ? 
                                    <span className="text-red-500 bg-red-50 px-2 py-1 rounded">ç„¡ä»»ä½•å›é¥‹</span> : 
                                    (editForm.noBonus ? <span className="text-orange-500 bg-orange-50 px-2 py-1 rounded">åƒ…åŸºæœ¬ 0.3%</span> : <span className="text-emerald-600 bg-emerald-50 px-2 py-1 rounded">é©ç”¨åŠ ç¢¼ 1.7%</span>)
                                }
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const isDangerBtn = type === 'danger' || isDanger;

        return (
            <div className={`fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/30 backdrop-blur-sm transition-opacity duration-200 ${isClosing ? 'opacity-0 pointer-events-none' : 'opacity-100'}`}>
                <div className={`glass-card w-full max-w-sm p-6 bg-white border-none shadow-2xl relative z-[101] ${isClosing ? 'modal-exit' : 'modal-enter'}`}>
                    <h3 className={`text-xl font-bold mb-3 ${isDangerBtn ? 'text-red-600' : 'text-gray-800'}`}>{title}</h3>
                    <div className="mb-6 max-h-[70vh] overflow-y-auto">{renderContent()}</div>
                    <div className="flex gap-3 justify-end">
                        {type !== 'info' && <button onClick={onCancel} disabled={processing} className="btn-touch px-4 py-2 rounded-xl bg-gray-50 text-gray-500 font-bold text-sm hover:bg-gray-100">{cancelText}</button>}
                        <button onClick={handleConfirm} disabled={processing} className={`btn-touch px-5 py-2 rounded-xl text-white font-bold text-sm shadow-lg flex items-center gap-2 transition-all ${isDangerBtn ? 'bg-red-500 shadow-red-200' : 'btn-primary'} ${processing ? 'opacity-80 cursor-wait pl-4 pr-6' : ''}`}>
                            {processing && <div className="loading-spinner w-4 h-4 border-white border-2 mr-1"></div>}{confirmText}
                        </button>
                    </div>
                </div>
            </div>
        );
    };

    const PrivacyPolicyContent = () => (
        <div className="space-y-4 text-sm text-gray-600 leading-relaxed">
            <div className="p-3 bg-slate-50 rounded-lg border border-slate-100">
                <p className="font-bold text-gray-800 mb-1">1. è³‡æ–™å­˜å–èˆ‡å®‰å…¨æ€§</p>
                <p>æœ¬æ‡‰ç”¨ç¨‹å¼æ¡ç”¨ Google Firebase æœå‹™è¨—ç®¡ã€‚æ‚¨çš„è³‡æ–™ï¼ˆå¸³è™Ÿè­˜åˆ¥ç¢¼ã€äº¤æ˜“ç´€éŒ„ï¼‰çš†ä»¥åŠ å¯†æ–¹å¼å„²å­˜ã€‚æˆ‘å€‘æ¡ç”¨åš´æ ¼çš„è³‡æ–™åº«æ¬Šé™è¦å‰‡ï¼Œç¢ºä¿åƒ…æœ‰æŒæœ‰æ­£ç¢º PIN ç¢¼çš„æ‚¨æœ¬äººèƒ½å­˜å–è³‡æ–™ã€‚</p>
            </div>
            <div className="p-3 bg-slate-50 rounded-lg border border-slate-100">
                <p className="font-bold text-gray-800 mb-1">2. è³‡æ–™æ”¶é›†ç¯„åœ</p>
                <p>æˆ‘å€‘åƒ…æ”¶é›†æœå‹™é‹ä½œæ‰€éœ€ä¹‹æœ€å°é™åº¦è³‡æ–™ï¼šä½¿ç”¨è€…è‡ªè¨‚ä¹‹å¸³è™Ÿã€æš±ç¨±åŠè¨˜å¸³æ˜ç´°ã€‚æœ¬æœå‹™<span className="text-red-500 font-bold">ä¸æ”¶é›†</span>æ‚¨çš„çœŸå¯¦å§“åã€èº«åˆ†è­‰å­—è™Ÿã€ä¿¡ç”¨å¡è™Ÿæˆ–ä½ç½®è³‡è¨Šã€‚</p>
            </div>
            <div className="p-3 bg-slate-50 rounded-lg border border-slate-100">
                <p className="font-bold text-gray-800 mb-1">3. ä½¿ç”¨è€…æ¬Šåˆ©</p>
                <p>æ‚¨æ“æœ‰è³‡æ–™çš„å®Œæ•´æ§åˆ¶æ¬Šï¼Œå¯éš¨æ™‚ä¿®æ”¹æš±ç¨±ã€æ¸…ç©ºè¨˜å¸³è³‡æ–™æˆ–æ°¸ä¹…åˆªé™¤å¸³è™Ÿã€‚åŸ·è¡Œåˆªé™¤å¾Œï¼Œè³‡æ–™å°‡å¾ä¼ºæœå™¨ä¸­æ°¸ä¹…ç§»é™¤ï¼Œç„¡æ³•å¾©åŸã€‚</p>
            </div>
            <div className="text-xs text-gray-400 mt-2 text-center pt-2 border-t">æœ¬ç¨‹å¼éåœ‹æ³°ä¸–è¯éŠ€è¡Œæˆ– LINE Pay å®˜æ–¹æä¾›ã€‚</div>
        </div>
    );

    const AuthScreen = ({ onShowPrivacy }) => {
        const [isRegister, setIsRegister] = useState(false);
        const [account, setAccount] = useState('');
        const [nickname, setNickname] = useState('');
        const [pin, setPin] = useState('');
        const [showPin, setShowPin] = useState(false);
        const [loading, setLoading] = useState(false);
        const [modal, setModal] = useState({ isOpen: false });

        const showModal = (title, content, type='danger') => setModal(() => ({ isOpen: true, title, content, type, onConfirm: () => setModal(p => ({ ...p, isOpen: false })), confirmText: 'ç¢ºå®š', onCancel: () => setModal(p => ({ ...p, isOpen: false })) }));
        const closeModal = () => setModal(p => ({ ...p, isOpen: false }));

        const handleAuth = async (e) => {
            e.preventDefault();
            if (pin.length !== 6 || !/^\d+$/.test(pin)) return showModal('æ ¼å¼éŒ¯èª¤', 'PIN ç¢¼å¿…é ˆæ˜¯ 6 ä½æ•¸å­—');
            if (!account.trim()) return showModal('æ ¼å¼éŒ¯èª¤', 'è«‹è¼¸å…¥å¸³è™Ÿ');
            if (isRegister && !nickname.trim()) return showModal('æ ¼å¼éŒ¯èª¤', 'è«‹è¼¸å…¥æ‚¨çš„æš±ç¨±');

            setLoading(true);
            await new Promise(r => setTimeout(r, 800));

            const fakeEmail = `${account.trim()}@cube.local`;

            try {
                if (isRegister) {
                    const userCredential = await createUserWithEmailAndPassword(auth, fakeEmail, pin);
                    const user = userCredential.user;
                    await updateProfile(user, { displayName: nickname });
                    await setDoc(doc(db, 'users', user.uid), { nickname: nickname, account: account.trim(), createdAt: Date.now() });
                } else {
                    await signInWithEmailAndPassword(auth, fakeEmail, pin);
                }
            } catch (err) {
                let msg = err.message;
                if (err.code === 'auth/invalid-credential' || err.code === 'auth/wrong-password') msg = 'å¸³è™Ÿä¸å­˜åœ¨æˆ– PIN ç¢¼éŒ¯èª¤ã€‚';
                else if (err.code === 'auth/user-not-found') msg = 'æ‰¾ä¸åˆ°æ­¤å¸³è™Ÿï¼Œè«‹å…ˆè¨»å†Šã€‚';
                else if (err.code === 'auth/email-already-in-use') msg = 'æ­¤å¸³è™Ÿå·²è¢«è¨»å†Šï¼Œè«‹æ›´æ›ã€‚';
                showModal('ç™»å…¥å¤±æ•—', msg);
            }
            setLoading(false);
        };

        return (
            <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-gradient-to-br from-emerald-50 to-teal-50">
                <Modal {...modal} isOpen={modal.isOpen} title={modal.title} content={modal.content} type={modal.type} onConfirm={modal.onConfirm} onCancel={closeModal} confirmText="ç¢ºå®š" enableDelay={true} />
                <div className="glass-card w-full max-w-sm p-8 relative overflow-hidden">
                    <div className="absolute top-0 right-0 -mt-16 -mr-16 w-48 h-48 bg-emerald-200/40 rounded-full blur-3xl"></div>
                    <div className="absolute bottom-0 left-0 -mb-16 -ml-16 w-48 h-48 bg-teal-200/40 rounded-full blur-3xl"></div>
                    <div className="relative z-10">
                        <div className="text-center mb-8">
                            <h1 className="text-2xl font-black text-emerald-800 tracking-tight leading-tight">åœ‹æ³°ä¸–è¯CUBEå¡<br/>LINE PAYå›é¥‹è¨ˆç®—å™¨</h1>
                        </div>
                        {isRegister && (
                            <div className="bg-amber-50 border border-amber-100 rounded-xl p-4 mb-6 text-xs text-amber-800 leading-relaxed">
                                <strong className="block mb-1 text-amber-900">âš ï¸ è¨»å†Šé ˆçŸ¥</strong>
                                é€™æ˜¯ç°¡æ˜“ç³»çµ±ï¼ŒPIN ç¢¼éºå¤±å°‡<b>ç„¡æ³•æ‰¾å›å¸³è™Ÿ</b>ã€‚
                            </div>
                        )}
                        <form onSubmit={handleAuth} className="space-y-4">
                            <div><label className="text-xs font-bold text-gray-500 uppercase ml-1 mb-1 block">å¸³è™Ÿ</label><input type="text" className="custom-input w-full rounded-xl p-3.5 text-gray-800 font-bold" value={account} onChange={e => setAccount(e.target.value)} /></div>
                            {isRegister && ( <div className="modal-anim"><label className="text-xs font-bold text-gray-500 uppercase ml-1 mb-1 block">æš±ç¨± (å¯éš¨æ™‚ä¿®æ”¹)</label><input type="text" className="custom-input w-full rounded-xl p-3.5 text-gray-800 font-bold" value={nickname} onChange={e => setNickname(e.target.value)} /></div> )}
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase ml-1 mb-1 block">6ä½æ•¸ PIN</label>
                                <div className="relative">
                                    <input type={showPin ? "tel" : "password"} inputMode="numeric" maxLength="6" className="custom-input w-full rounded-xl p-3.5 text-center font-mono text-xl tracking-widest text-gray-800" value={pin} onChange={e => { const val = e.target.value.replace(/\D/g, ''); if(val.length<=6) setPin(val); }} />
                                    <button type="button" onClick={() => setShowPin(!showPin)} className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-emerald-600 w-10 h-10 flex items-center justify-center transition-colors rounded-full active:bg-gray-100">
                                        <i className={`fa-regular ${showPin ? 'fa-eye-slash' : 'fa-eye'}`}></i>
                                    </button>
                                </div>
                            </div>
                            <button type="submit" disabled={loading} className="btn-primary btn-touch w-full py-4 rounded-xl font-bold text-lg mt-4 flex justify-center items-center">{loading ? <div className="loading-spinner border-white border-t-transparent"></div> : (isRegister ? 'ç«‹å³è¨»å†Š' : 'ç™»å…¥')}</button>
                        </form>
                        <div className="mt-8 text-center space-y-4">
                            <button onClick={() => { setIsRegister(!isRegister); setPin(''); setShowPin(false); }} className="text-sm font-bold text-gray-500 hover:text-emerald-600 transition btn-touch">{isRegister ? 'å·²æœ‰å¸³è™Ÿï¼Ÿè¿”å›ç™»å…¥' : 'ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Ÿå»ºç«‹æ–°å¸³è™Ÿ'}</button>
                            <div><button onClick={onShowPrivacy} className="text-xs text-gray-400 hover:text-gray-600 flex items-center justify-center gap-1 mx-auto btn-touch"><i className="fa-solid fa-shield-halved mr-1"></i> éš±ç§æ¬Šæ”¿ç­–</button></div>
                        </div>
                    </div>
                </div>
            </div>
        );
    };

    const MainApp = ({ user, onLogout, onShowPrivacy }) => {
        const [transactions, setTransactions] = useState([]);
        const [currentMonth, setCurrentMonth] = useState(new Date().toISOString().substring(0, 7));
        const [toast, setToast] = useState({ show: false, message: '' });
        const [sortConfig, setSortConfig] = useState({ key: 'date', direction: 'desc' });
        const [modal, setModal] = useState({ isOpen: false, type: 'info', title: '', content: '' });
        const [showSettings, setShowSettings] = useState(false);
        const [currentNickname, setCurrentNickname] = useState(user.displayName || 'ä½¿ç”¨è€…');
        const [filterCategory, setFilterCategory] = useState('all');
        const canvasRef = useRef(null);
        const settingsRef = useRef(null);

        useEffect(() => { window.scrollTo(0, 0); }, []);

        useEffect(() => {
            const handleBeforeUnload = (e) => { e.preventDefault(); e.returnValue = ''; };
            window.addEventListener('beforeunload', handleBeforeUnload);
            const handleClickOutside = (event) => { if (settingsRef.current && !settingsRef.current.contains(event.target)) setShowSettings(false); };
            document.addEventListener("mousedown", handleClickOutside);
            return () => {
                window.removeEventListener('beforeunload', handleBeforeUnload);
                document.removeEventListener("mousedown", handleClickOutside);
            };
        }, []);

        useEffect(() => {
            const unsubUser = onSnapshot(doc(db, 'users', user.uid), (docSnap) => { if (docSnap.exists() && docSnap.data().nickname) setCurrentNickname(docSnap.data().nickname); });
            const q = query(collection(db, 'users', user.uid, 'records'), orderBy('date', 'desc'));
            const unsubTrans = onSnapshot(q, (snapshot) => { setTransactions(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); });
            return () => { unsubUser(); unsubTrans(); };
        }, [user]);

        const showToast = (message) => {
            setToast({ show: true, message });
            setTimeout(() => { setToast({ show: false, message: '' }); }, 2000);
        };

        const monthlyData = transactions.filter(t => t.date.startsWith(currentMonth));
        
        // --- æ ¸å¿ƒé‚è¼¯ ---
        const _validCount = monthlyData.filter(t => !t.excluded).length;
        const _isQualified = _validCount >= 8;
        
        const processedList = [...monthlyData]
            .filter(t => filterCategory === 'all' || (t.category || 'general') === filterCategory)
            .sort((a,b) => {
                let res = 0;
                if (sortConfig.key === 'date') res = a.date.localeCompare(b.date);
                else if (sortConfig.key === 'merchant') res = a.merchant.localeCompare(b.merchant, 'zh-Hant');
                if (res === 0) res = a.createdAt - b.createdAt;
                return sortConfig.direction === 'asc' ? res : -res;
            }).map(t=>{
                // å–®ç­†åŸºæœ¬å›é¥‹
                let base = 0;
                if (!t.excluded) {
                    base = Math.round(t.amount * 0.003);
                }
                // å–®ç­†é ä¼°åŠ ç¢¼
                let estimateBonus = 0;
                if (!t.excluded && !t.noBonus) {
                    estimateBonus = Math.round(t.amount * 0.017);
                }
                return { ...t, base, estimateBonus };
            });

        const totalBase = processedList.reduce((acc, t) => acc + t.base, 0);
        
        // åŠ ç¢¼å›é¥‹è¨ˆç®— (æ•´æœˆç¸½é¡åˆ¶)
        const bonusEligibleAmount = monthlyData
            .filter(t => !t.excluded && !t.noBonus)
            .reduce((acc, t) => acc + t.amount, 0);

        let totalBonus = 0;
        if (_isQualified) {
            totalBonus = Math.min(100, Math.round(bonusEligibleAmount * 0.017));
        }

        const MAX_BONUS_SPEND = 5883; 
        const remainingSpend = Math.max(0, MAX_BONUS_SPEND - bonusEligibleAmount);

        useEffect(() => {
            if (!canvasRef.current) return;
            const ctx = canvasRef.current.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            const rect = canvasRef.current.getBoundingClientRect();
            canvasRef.current.width = rect.width * dpr;
            canvasRef.current.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            const W = rect.width;
            const H = rect.height;
            ctx.clearRect(0,0,W,H);
            
            const radius = Math.min(W/6 - 8, 50);
            
            const drawRing = (x, y, cur, max, c, lbl, sub, r) => {
                ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.strokeStyle='#e2e8f0'; ctx.lineWidth=8; ctx.stroke();
                const pct = Math.min(cur/max,1);
                if(pct>0){ ctx.beginPath(); ctx.arc(x,y,r,-Math.PI/2,(-Math.PI/2)+(pct*Math.PI*2)); ctx.strokeStyle=c; ctx.lineWidth=8; ctx.lineCap='round'; ctx.stroke(); }
                
                const titleSize = Math.max(12, r * 0.55);
                const subSize = Math.max(9, r * 0.22);
                const lblSize = Math.max(10, r * 0.25);

                ctx.fillStyle='#334155'; ctx.font=`bold ${titleSize}px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto`; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(cur,x,y-r*0.1);
                ctx.fillStyle='#94a3b8'; ctx.font=`${subSize}px sans-serif`; ctx.fillText('/ '+max,x,y+r*0.45);
                ctx.fillStyle=c; ctx.font=`bold ${lblSize}px sans-serif`; ctx.fillText(lbl,x,y+r*1.4);
                ctx.fillStyle='#64748b'; ctx.font=`${subSize}px sans-serif`; ctx.fillText(sub,x,y+r*1.8);
            };

            const centerY = H/2 - 10;
            
            drawRing(W * 0.166, centerY, _validCount, 8, _isQualified?'#10b981':'#f59e0b', 'åˆæ ¼ç­†æ•¸', _isQualified?'å·²é”æ¨™':`å·® ${8-_validCount} ç­†`, radius);
            drawRing(W * 0.5, centerY, bonusEligibleAmount, MAX_BONUS_SPEND, '#3b82f6', 'åŠ ç¢¼æ¶ˆè²»', `é¤˜ $${remainingSpend}`, radius);
            drawRing(W * 0.833, centerY, totalBonus, 100, totalBonus>=100?'#ef4444':'#10b981', 'åŠ ç¢¼å›é¥‹', totalBonus>=100?'å·²å°é ‚':'æœªå°é ‚', radius);

            ctx.beginPath(); 
            ctx.moveTo(W/3, 10); ctx.lineTo(W/3, H-30); 
            ctx.moveTo(2*W/3, 10); ctx.lineTo(2*W/3, H-30);
            ctx.strokeStyle='#e2e8f0'; ctx.lineWidth=1; ctx.stroke();

        }, [transactions, currentMonth]);

        const showModal = (cfg) => setModal(() => ({ ...cfg, isOpen: true }));
        const closeModal = () => setModal(p => ({ ...p, isOpen: false }));

        const handleLogout = () => {
            showModal({
                title: 'ç™»å‡ºç¢ºèª',
                content: 'æ‚¨ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ',
                type: 'danger',
                confirmText: 'ç™»å‡º',
                onConfirm: async () => { await onLogout(); closeModal(); },
                onCancel: closeModal
            });
        };

        const openAddTxModal = () => {
            showModal({
                title: 'æ–°å¢äº¤æ˜“',
                type: 'addTransaction',
                confirmText: 'æ–°å¢',
                cancelText: 'å–æ¶ˆ',
                onConfirm: async (newForm) => {
                    if (!newForm.merchant || !newForm.amount) return alert('è«‹å¡«å¯«å•†å®¶èˆ‡é‡‘é¡');
                    await addDoc(collection(db, 'users', user.uid, 'records'), { ...newForm, amount: parseInt(newForm.amount), createdAt: Date.now() });
                    closeModal();
                    showToast('æ–°å¢æˆåŠŸ');
                    window.scrollTo({ top: 0, behavior: 'smooth' }); // ç½®é ‚
                },
                onCancel: closeModal
            });
        };

        const delTx = (id) => { showModal({ title: 'åˆªé™¤ç´€éŒ„', content: 'ç¢ºå®šè¦åˆªé™¤é€™ç­†äº¤æ˜“å—ï¼Ÿ', type: 'danger', confirmText: 'åˆªé™¤', cancelText:'å–æ¶ˆ', onConfirm: async () => { await deleteDoc(doc(db, 'users', user.uid, 'records', id)); closeModal(); showToast('åˆªé™¤æˆåŠŸ'); }, onCancel: closeModal }); };
        
        const editTx = (tx) => {
            showModal({
                title: 'ç·¨è¼¯äº¤æ˜“ç´€éŒ„',
                type: 'editTransaction',
                editingData: tx,
                confirmText: 'å„²å­˜',
                cancelText: 'å–æ¶ˆ',
                onConfirm: async (newForm) => {
                    if (!newForm.merchant || !newForm.amount) return alert('è«‹å¡«å¯«å•†å®¶èˆ‡é‡‘é¡');
                    await updateDoc(doc(db, 'users', user.uid, 'records', tx.id), {
                        date: newForm.date,
                        merchant: newForm.merchant,
                        amount: newForm.amount,
                        excluded: newForm.excluded,
                        noBonus: newForm.noBonus,
                        category: newForm.category
                    });
                    closeModal();
                    showToast('ä¿®æ”¹æˆåŠŸ');
                },
                onCancel: closeModal
            });
        };
        
        const changeNickname = () => { showModal({ title: 'ä¿®æ”¹æš±ç¨±', content: 'è«‹è¼¸å…¥æ–°çš„æš±ç¨±ï¼š', type: 'input', inputPlaceholder: currentNickname, inputValue: currentNickname, confirmText: 'å„²å­˜', cancelText:'å–æ¶ˆ', onConfirm: async (newVal) => { if(!newVal.trim()) return alert('æš±ç¨±ä¸èƒ½ç‚ºç©º'); await updateProfile(user, { displayName: newVal }); await setDoc(doc(db, 'users', user.uid), { nickname: newVal }, { merge: true }); closeModal(); showToast('ä¿®æ”¹æˆåŠŸ'); }, onCancel: closeModal }); };
        const changePin = () => { showModal({ title: 'ä¿®æ”¹ PIN ç¢¼', type: 'changePin', confirmText: 'ç¢ºèªä¿®æ”¹', cancelText:'å–æ¶ˆ', onConfirm: async (oldPin, newPin) => { if(!oldPin || !newPin) return alert('è«‹è¼¸å…¥èˆŠ PIN èˆ‡æ–° PIN'); if(newPin.length !== 6) return alert('æ–° PIN ç¢¼å¿…é ˆæ˜¯ 6 ä½æ•¸å­—'); try { const credential = EmailAuthProvider.credential(user.email, oldPin); await reauthenticateWithCredential(user, credential); await updatePassword(user, newPin); closeModal(); showToast('ä¿®æ”¹æˆåŠŸ'); } catch(e) { if(e.code === 'auth/invalid-credential' || e.code === 'auth/wrong-password') alert('èˆŠ PIN ç¢¼éŒ¯èª¤'); else alert('ä¿®æ”¹å¤±æ•—ï¼š' + e.message); throw e; } }, onCancel: closeModal }); };
        const clearData = () => { showModal({ title: 'æ¸…ç©ºè³‡æ–™', content: 'ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è¨˜å¸³ç´€éŒ„å—ï¼Ÿ', type: 'danger', confirmText: 'ç¢ºèªæ¸…ç©º', cancelText:'å–æ¶ˆ', onConfirm: async () => { const snapshot = await getDocs(query(collection(db, 'users', user.uid, 'records'))); await Promise.all(snapshot.docs.map(d => deleteDoc(d.ref))); closeModal(); showToast('å·²æ¸…ç©ºè³‡æ–™'); }, onCancel: closeModal }); };
        
        const deleteAccount = () => { 
            const accName = user.email.split('@')[0]; 
            showModal({ 
                title: 'åˆªé™¤å¸³è™Ÿ', 
                content: `è«‹è¼¸å…¥æ‚¨çš„å¸³è™Ÿåç¨±ã€Œ${accName}ã€ä»¥ç¢ºèªåˆªé™¤ã€‚`, 
                type: 'input', 
                isDanger: true, 
                inputPlaceholder: accName, 
                confirmText: 'æ°¸ä¹…åˆªé™¤', 
                cancelText:'å–æ¶ˆ', 
                onConfirm: async (val) => { 
                    if (val !== accName) return alert('å¸³è™Ÿåç¨±è¼¸å…¥éŒ¯èª¤'); 
                    try { 
                        const snapshot = await getDocs(query(collection(db, 'users', user.uid, 'records'))); 
                        await Promise.all(snapshot.docs.map(d => deleteDoc(d.ref))); 
                        await deleteDoc(doc(db, 'users', user.uid)); 
                        await deleteUser(user); 
                    } catch (e) { 
                        alert('åˆªé™¤å¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥å¾Œå†è©¦'); 
                    } 
                }, 
                onCancel: closeModal 
            }); 
        };

        const monthOptions = [...new Set(transactions.map(t=>t.date.substring(0,7))), new Date().toISOString().substring(0,7)].sort().reverse();
        
        const toggleSort = (key) => {
            setSortConfig(prev => ({
                key,
                direction: prev.key === key && prev.direction === 'desc' ? 'asc' : 'desc'
            }));
        };

        return (
            <div className="container mx-auto max-w-2xl p-4 pb-24">
                <Modal {...modal} onCancel={closeModal} />
                <Toast show={toast.show} message={toast.message} />
                
                <div className="flex justify-between items-center mb-6 pl-2 relative z-50">
                    <div className="text-2xl font-black text-gray-800 tracking-tight">{currentNickname}ï¼Œæ‚¨å¥½ï¼</div>
                    <div className="flex gap-2 relative" ref={settingsRef}>
                        <button onClick={() => setShowSettings(!showSettings)} className={`p-2.5 rounded-full btn-touch transition-all duration-200 ${showSettings ? 'bg-emerald-50 text-emerald-600 shadow-inner' : 'bg-white text-gray-400 shadow-sm border border-gray-200 hover:text-emerald-600'}`}><i className="fa-solid fa-gear text-lg"></i></button>
                        {showSettings && (
                            <div className="absolute right-0 top-12 w-64 bg-white rounded-2xl shadow-xl border border-gray-100 p-2 z-[999] dropdown-anim origin-top-right">
                                <div className="text-[10px] font-bold text-gray-400 px-3 py-2 uppercase tracking-wider">è¨­å®šé¸é …</div>
                                <div className="space-y-1">
                                    <button onClick={() => { changeNickname(); setShowSettings(false); }} className="w-full text-left px-3 py-2.5 rounded-xl text-sm font-bold text-gray-700 hover:bg-emerald-50 hover:text-emerald-700 flex items-center gap-3 transition-colors"><span className="p-1.5 bg-emerald-100 rounded-lg text-emerald-600"><i className="fa-solid fa-pen-to-square"></i></span> ä¿®æ”¹æš±ç¨±</button>
                                    <button onClick={() => { changePin(); setShowSettings(false); }} className="w-full text-left px-3 py-2.5 rounded-xl text-sm font-bold text-gray-700 hover:bg-violet-50 hover:text-violet-700 flex items-center gap-3 transition-colors"><span className="p-1.5 bg-violet-100 rounded-lg text-violet-600"><i className="fa-solid fa-key"></i></span> ä¿®æ”¹ PIN ç¢¼</button>
                                    <button onClick={() => { onShowPrivacy(); setShowSettings(false); }} className="w-full text-left px-3 py-2.5 rounded-xl text-sm font-bold text-gray-700 hover:bg-blue-50 hover:text-blue-700 flex items-center gap-3 transition-colors"><span className="p-1.5 bg-blue-100 rounded-lg text-blue-600"><i className="fa-solid fa-shield-halved"></i></span> éš±ç§æ¬Šæ”¿ç­–</button>
                                    <div className="h-px bg-gray-100 my-1"></div>
                                    <button onClick={() => { clearData(); setShowSettings(false); }} className="w-full text-left px-3 py-2.5 rounded-xl text-sm font-bold text-gray-700 hover:bg-amber-50 hover:text-amber-700 flex items-center gap-3 transition-colors"><span className="p-1.5 bg-amber-100 rounded-lg text-amber-600"><i className="fa-solid fa-trash-can"></i></span> æ¸…é™¤è³‡æ–™</button>
                                    <button onClick={() => { deleteAccount(); setShowSettings(false); }} className="w-full text-left px-3 py-2.5 rounded-xl text-sm font-bold text-red-600 hover:bg-red-50 flex items-center gap-3 transition-colors"><span className="p-1.5 bg-red-100 rounded-lg text-red-500"><i className="fa-solid fa-trash-can"></i></span> åˆªé™¤å¸³è™Ÿ</button>
                                </div>
                                <div className="mt-2 pt-2 border-t border-gray-100"><button onClick={handleLogout} className="w-full text-center py-2 text-xs font-bold text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-50 transition">ç™»å‡ºå¸³è™Ÿ</button></div>
                            </div>
                        )}
                    </div>
                </div>
                
                <div className="flex justify-center mb-8">
                    <canvas ref={canvasRef} style={{width: '100%', maxWidth: '500px'}} height={160} className="w-full h-auto"></canvas>
                </div>
                
                <div className="flex justify-between items-end mb-4 px-2">
                    <select value={currentMonth} onChange={e=>setCurrentMonth(e.target.value)} className="bg-white border-none py-2 px-4 rounded-xl shadow-sm text-lg font-bold text-gray-700 outline-none cursor-pointer hover:bg-gray-50 transition">{monthOptions.map(m=><option key={m} value={m}>{m.replace('-', '/')}</option>)}</select>
                    <div className="text-right">
                        <div className="text-sm text-gray-500 font-bold mb-1">æœ¬æœˆé ä¼°å›é¥‹</div>
                        <div className="flex flex-col items-end">
                            <div className="text-xs font-bold text-gray-500">åŸºæœ¬ 0.3%: <span className="text-gray-800 text-base">{totalBase} å°æ¨¹é»</span></div>
                            <div className="flex gap-4 mt-2 bg-white p-2 rounded-lg border border-gray-100 shadow-sm">
                                <div className="text-right"><div className="text-[10px] text-gray-400 font-bold mb-0.5">åŠ ç¢¼ (æ•´æœˆçµç®—)</div><div className="text-emerald-600 font-bold text-base leading-none">{totalBonus} <span className="text-[10px]">å°æ¨¹é»</span></div></div>
                            </div>
                            <div className="text-[9px] text-gray-300 mt-1 text-right">*åŠ ç¢¼å›é¥‹æ¡æ•´æœˆç¸½é¡ x 1.7% è¨ˆç®— (å››æ¨äº”å…¥)</div>
                        </div>
                    </div>
                </div>

                <div className="flex items-center gap-3 mb-2 px-2">
                     <button onClick={() => toggleSort('date')} className={`flex items-center gap-1 text-xs font-bold px-3 py-1.5 rounded-full transition ${sortConfig.key === 'date' ? 'bg-emerald-100 text-emerald-700' : 'bg-white text-gray-400'}`}>æ—¥æœŸ <i className={`fa-solid ${sortConfig.key === 'date' ? (sortConfig.direction === 'asc' ? 'fa-sort-up' : 'fa-sort-down') : 'fa-sort'}`}></i></button>
                     <button onClick={() => toggleSort('merchant')} className={`flex items-center gap-1 text-xs font-bold px-3 py-1.5 rounded-full transition ${sortConfig.key === 'merchant' ? 'bg-emerald-100 text-emerald-700' : 'bg-white text-gray-400'}`}>å•†å®¶ <i className={`fa-solid ${sortConfig.key === 'merchant' ? (sortConfig.direction === 'asc' ? 'fa-sort-up' : 'fa-sort-down') : 'fa-sort'}`}></i></button>
                </div>

                <div className="flex gap-2 overflow-x-auto pb-2 mb-2 px-2 no-scrollbar" style={{scrollbarWidth: 'none', msOverflowStyle: 'none'}}>
                    <button onClick={() => setFilterCategory('all')} className={`whitespace-nowrap px-4 py-1.5 rounded-full text-xs font-bold transition-colors ${filterCategory === 'all' ? 'bg-gray-800 text-white' : 'bg-white text-gray-500 shadow-sm'}`}>å…¨éƒ¨</button>
                    {CATEGORIES.map(c => (
                        <button key={c.id} onClick={() => setFilterCategory(c.id)} className={`whitespace-nowrap px-4 py-1.5 rounded-full text-xs font-bold transition-colors flex items-center gap-1 ${filterCategory === c.id ? 'bg-gray-800 text-white' : 'bg-white text-gray-500 shadow-sm'}`}>
                            <i className={c.icon}></i> {c.name}
                        </button>
                    ))}
                </div>

                <div className="space-y-3">
                    {processedList.length===0 ? <div className="text-center p-8 text-gray-400">å°šç„¡è³‡æ–™</div> : processedList.map(t=>(
                        <div key={t.id} className={`app-card p-4 ${t.excluded ? 'opacity-60 bg-slate-50' : ''}`}>
                            <div className="flex flex-col gap-2">
                                <div className="flex justify-between items-start">
                                    <div className="flex items-center gap-2">
                                        <div className="text-xs text-gray-400 font-bold tracking-tight">{t.date.replace(/-/g, '/')}</div>
                                        <span className="text-xs text-gray-500"><i className={CATEGORIES.find(c => c.id === (t.category || 'general'))?.icon}></i></span>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={()=>editTx(t)} className="text-gray-400 hover:text-blue-500 transition btn-touch"><i className="fa-solid fa-pen"></i></button>
                                        <button onClick={()=>delTx(t.id)} className="text-gray-300 hover:text-red-500 transition btn-touch"><i className="fa-solid fa-trash-can"></i></button>
                                    </div>
                                </div>
                                <div className="flex justify-between items-center gap-4">
                                    <div className="font-bold text-gray-800 text-lg break-words flex-1 leading-tight">{t.merchant}</div>
                                    <div className="text-xl font-sans font-bold text-gray-800 tracking-tight whitespace-nowrap">${t.amount.toLocaleString()}</div>
                                </div>
                                <div className="flex items-center gap-2 mt-1">
                                    {t.excluded ? <span className="badge badge-excluded">ä¸è¨ˆå›é¥‹</span> : <div className="flex gap-1.5 flex-wrap"><span className="badge badge-base">åŸºæœ¬ {t.base} å°æ¨¹é»</span>{t.noBonus ? <span className="badge badge-warning">ç„¡åŠ ç¢¼</span> : <span className="badge badge-bonus">åŠ ç¢¼ç´„ {t.estimateBonus} å°æ¨¹é»</span>}</div>}
                                </div>
                            </div>
                        </div>
                    ))}
                </div>

                <button onClick={openAddTxModal} className="fixed bottom-6 right-6 w-14 h-14 bg-emerald-600 text-white rounded-full shadow-xl shadow-emerald-200 flex items-center justify-center btn-touch z-50 hover:bg-emerald-700 transition-colors"><i className="fa-solid fa-plus text-xl"></i></button>
            </div>
        );
    };

    const App = () => {
        const [user, setUser] = useState(null);
        const [init, setInit] = useState(true);
        const [privacyOpen, setPrivacyOpen] = useState(false);
        useEffect(() => onAuthStateChanged(auth, (u) => { setUser(u); setInit(false); }), []);
        if (init) return <div className="min-h-screen flex items-center justify-center"><div className="loading-spinner w-10 h-10 border-4"></div></div>;
        return (
            <>
                <Modal isOpen={privacyOpen} title="éš±ç§æ¬Šæ”¿ç­–" content={<PrivacyPolicyContent/>} onConfirm={()=>setPrivacyOpen(false)} confirmText="æˆ‘ç­è§£äº†" type="info" />
                {user ? <MainApp user={user} onLogout={()=>signOut(auth)} onShowPrivacy={()=>setPrivacyOpen(true)} /> : <AuthScreen onShowPrivacy={()=>setPrivacyOpen(true)} />}
            </>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>
