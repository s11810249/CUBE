<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åœ‹æ³°ä¸–è¯CUBEå¡LINE PAYå›é¥‹è¨ˆç®—å™¨</title>
    
    <!-- React & Tailwind -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase SDK -->
    <script type="importmap">
      {
        "imports": {
          "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
          "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
          "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
        }
      }
    </script>

    <style>
        body { 
            background-color: #f8fafc;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            min-height: 100vh;
            color: #1f2937;
            padding-bottom: 40px;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            border-radius: 1.5rem;
        }

        .app-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border-radius: 1.5rem;
        }

        .btn-touch { transition: all 0.1s ease-in-out; }
        .btn-touch:active { transform: scale(0.96); filter: brightness(0.95); }

        .btn-primary {
            background: linear-gradient(135deg, #059669 0%, #0f766e 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(13, 148, 136, 0.25);
        }
        .btn-primary:active { box-shadow: 0 2px 6px rgba(13, 148, 136, 0.2); }

        .custom-input {
            border: 2px solid #f3f4f6;
            background: #f9fafb;
            transition: all 0.2s;
            appearance: none; 
        }
        .custom-input:focus {
            background: #fff;
            border-color: #059669;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
            outline: none;
        }

        @keyframes modalPop { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-anim { animation: modalPop 0.2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }

        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #059669; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .badge { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 999px; font-size: 0.7rem; font-weight: 700; }
        .badge-base { background: #f3f4f6; color: #6b7280; }
        .badge-bonus { background: #d1fae5; color: #059669; }
        .badge-capped { background: #fee2e2; color: #dc2626; }
        .badge-excluded { background: #e5e7eb; color: #9ca3af; text-decoration: line-through; }
        
        .table-header { font-size: 0.75rem; font-weight: 700; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.05em; }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel" data-type="module" data-presets="react">
    import { initializeApp } from 'firebase/app';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, deleteUser, updateProfile, updatePassword, EmailAuthProvider, reauthenticateWithCredential } from 'firebase/auth';
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc, getDocs, setDoc, updateDoc } from 'firebase/firestore';
    
    // ==========================================================
    // ğŸ”¥ è«‹åœ¨æ­¤è™•å¡«å…¥ä½ çš„ Firebase Config
    // ==========================================================
    const firebaseConfig = {
        apiKey: "AIzaSyCZI5fxjjrsoKgUBIVU5s1YqvAYdn_CL88",
        authDomain: "cub-linepay.firebaseapp.com",
        projectId: "cub-linepay",
        storageBucket: "cub-linepay.firebasestorage.app",
        messagingSenderId: "469367852222",
        appId: "1:469367852222:web:9f3a855dd501849d57a2ef"
    };
    // ==========================================================

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const { useState, useEffect, useRef } = React;

    const Icons = {
        Eye: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
        EyeOff: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07-2.3 2.3"/><line x1="1" y1="1" x2="23" y2="23"/></svg>,
        Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
        Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>,
        Shield: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>,
        Edit: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>,
        Key: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path></svg>
    };

    // --- é€šç”¨ Modal çµ„ä»¶ (ç¢ºä¿ onCancel/onConfirm åŸ·è¡Œè·¯å¾‘æ­£ç¢º) ---
    const Modal = ({ isOpen, title, content, type = 'info', onConfirm, onCancel, confirmText = 'ç¢ºå®š', cancelText = 'å–æ¶ˆ', inputPlaceholder, inputValue: initialInputValue, editingData }) => {
        if (!isOpen) return null;
        const [val, setVal] = useState(initialInputValue || '');
        const [val2, setVal2] = useState('');
        const [processing, setProcessing] = useState(false);

        useEffect(() => { 
            if (isOpen && initialInputValue) setVal(initialInputValue);
        }, [isOpen, initialInputValue]);

        const [editForm, setEditForm] = useState({ 
            date: editingData?.date || new Date().toISOString().substring(0, 10), 
            merchant: editingData?.merchant || '', 
            amount: editingData?.amount || 0, 
            excluded: editingData?.excluded || false 
        });

        useEffect(() => { 
            if (isOpen && editingData) {
                 setEditForm({ date: editingData.date, merchant: editingData.merchant, amount: editingData.amount, excluded: editingData.excluded });
            }
        }, [isOpen, editingData]);


        const handleConfirm = async () => {
            if (processing) return;
            setProcessing(true);
            try {
                if (type === 'input') await onConfirm(val);
                else if (type === 'changePin') await onConfirm(val, val2);
                else if (type === 'editTransaction') await onConfirm(editForm);
                else await onConfirm();
            } catch(e) { console.error(e); }
            setProcessing(false);
        };
        
        // æ¸²æŸ“å…§å®¹
        const renderContent = () => {
            if (typeof content === 'string') return <p>{content}</p>;
            if (type === 'input') return <input type="text" className="custom-input w-full mt-4 p-3 rounded-xl text-lg font-bold text-gray-800" placeholder={inputPlaceholder} value={val} onChange={e => setVal(e.target.value)} autoFocus />;
            if (type === 'changePin') return (
                <div className="space-y-3 mt-4">
                    <div><label className="text-xs font-bold text-gray-500">èˆŠ PIN ç¢¼</label><input type="tel" maxLength="6" className="custom-input w-full p-2.5 rounded-xl text-center text-lg font-mono tracking-widest" value={val} onChange={e => setVal(e.target.value.replace(/\D/g, ''))} /></div>
                    <div><label className="text-xs font-bold text-gray-500">æ–° PIN ç¢¼</label><input type="tel" maxLength="6" className="custom-input w-full p-2.5 rounded-xl text-center text-lg font-mono tracking-widest" value={val2} onChange={e => setVal2(e.target.value.replace(/\D/g, ''))} /></div>
                </div>
            );
            if (type === 'editTransaction') return (
                <div className="space-y-3 mt-4">
                    <div><label className="text-xs font-bold text-gray-500">æ—¥æœŸ</label><input type="date" className="custom-input w-full p-2.5 rounded-xl" value={editForm.date} onChange={e => setEditForm({ ...editForm, date: e.target.value })} /></div>
                    <div><label className="text-xs font-bold text-gray-500">å•†å®¶</label><input type="text" className="custom-input w-full p-2.5 rounded-xl" value={editForm.merchant} onChange={e => setEditForm({ ...editForm, merchant: e.target.value })} /></div>
                    <div><label className="text-xs font-bold text-gray-500">é‡‘é¡</label><input type="number" className="custom-input w-full p-2.5 rounded-xl" value={editForm.amount} onChange={e => setEditForm({ ...editForm, amount: parseInt(e.target.value) })} /></div>
                    <label className="flex items-center text-sm text-gray-600 font-bold cursor-pointer"><input type="checkbox" className="mr-2 w-5 h-5 accent-emerald-600 rounded" checked={editForm.excluded} onChange={e => setEditForm({ ...editForm, excluded: e.target.checked })} />éä¸€èˆ¬æ¶ˆè²»</label>
                </div>
            );
            return content;
        };


        return (
            <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-gray-900/40 backdrop-blur-sm transition-opacity">
                <div className="glass-card w-full max-w-sm p-6 modal-anim bg-white border-none shadow-2xl relative z-[101]">
                    <h3 className={`text-xl font-bold mb-3 ${type === 'danger' ? 'text-red-600' : 'text-gray-800'}`}>{title}</h3>
                    <div className="text-gray-600 mb-6 text-sm leading-relaxed max-h-[70vh] overflow-y-auto">
                        {renderContent()}
                    </div>
                    <div className="flex gap-3 justify-end">
                        {/* ä¿®æ­£ï¼šç¢ºä¿ onCancel ç¸½æ˜¯åŸ·è¡Œ closeModal */}
                        {type !== 'info' && <button onClick={onCancel} disabled={processing} className="btn-touch px-4 py-2 rounded-xl bg-gray-100 text-gray-500 font-bold text-sm">{cancelText}</button>}
                        <button onClick={handleConfirm} disabled={processing} className={`btn-touch px-5 py-2 rounded-xl text-white font-bold text-sm shadow-lg flex items-center gap-2 ${type === 'danger' ? 'bg-red-500 shadow-red-200' : 'btn-primary'} ${processing ? 'opacity-70 cursor-not-allowed' : ''}`}>
                            {processing && <div className="loading-spinner w-4 h-4 border-white border-2"></div>}{confirmText}
                        </button>
                    </div>
                </div>
            </div>
        );
    };

    const PrivacyPolicyContent = () => (
        <div className="space-y-4 text-sm text-gray-600 leading-relaxed">
            <div className="p-3 bg-gray-50 rounded-lg border border-gray-100">
                <p className="font-bold text-gray-800 mb-1">1. è³‡æ–™å­˜å–èˆ‡å®‰å…¨æ€§</p>
                <p>æœ¬æ‡‰ç”¨ç¨‹å¼æ¡ç”¨ Google Firebase æœå‹™è¨—ç®¡ã€‚æ‚¨çš„è³‡æ–™ï¼ˆå¸³è™Ÿè­˜åˆ¥ç¢¼ã€äº¤æ˜“ç´€éŒ„ï¼‰çš†ä»¥åŠ å¯†æ–¹å¼å„²å­˜ã€‚æˆ‘å€‘æ¡ç”¨åš´æ ¼çš„è³‡æ–™åº«æ¬Šé™è¦å‰‡ï¼Œç¢ºä¿åƒ…æœ‰æŒæœ‰æ­£ç¢º PIN ç¢¼çš„æ‚¨æœ¬äººèƒ½å­˜å–è³‡æ–™ã€‚</p>
            </div>
            <div className="p-3 bg-gray-50 rounded-lg border border-gray-100">
                <p className="font-bold text-gray-800 mb-1">2. è³‡æ–™æ”¶é›†ç¯„åœ</p>
                <p>æˆ‘å€‘åƒ…æ”¶é›†æœå‹™é‹ä½œæ‰€éœ€ä¹‹æœ€å°é™åº¦è³‡æ–™ï¼šä½¿ç”¨è€…è‡ªè¨‚ä¹‹å¸³è™Ÿã€æš±ç¨±åŠè¨˜å¸³æ˜ç´°ã€‚æœ¬æœå‹™<span className="text-red-500 font-bold">ä¸æ”¶é›†</span>æ‚¨çš„çœŸå¯¦å§“åã€èº«åˆ†è­‰å­—è™Ÿã€ä¿¡ç”¨å¡è™Ÿæˆ–ä½ç½®è³‡è¨Šã€‚</p>
            </div>
            <div className="p-3 bg-gray-50 rounded-lg border border-gray-100">
                <p className="font-bold text-gray-800 mb-1">3. ä½¿ç”¨è€…æ¬Šåˆ©</p>
                <p>æ‚¨æ“æœ‰è³‡æ–™çš„å®Œæ•´æ§åˆ¶æ¬Šï¼Œå¯éš¨æ™‚ä¿®æ”¹æš±ç¨±ã€æ¸…ç©ºè¨˜å¸³è³‡æ–™æˆ–æ°¸ä¹…åˆªé™¤å¸³è™Ÿã€‚åŸ·è¡Œåˆªé™¤å¾Œï¼Œè³‡æ–™å°‡å¾ä¼ºæœå™¨ä¸­æ°¸ä¹…ç§»é™¤ï¼Œç„¡æ³•å¾©åŸã€‚</p>
            </div>
            <div className="text-xs text-gray-400 mt-2 text-center pt-2 border-t">æœ¬ç¨‹å¼éåœ‹æ³°ä¸–è¯éŠ€è¡Œæˆ– LINE Pay å®˜æ–¹æä¾›ã€‚</div>
        </div>
    );

    // --- ç™»å…¥ç•«é¢ ---
    const AuthScreen = ({ onShowPrivacy }) => {
        const [isRegister, setIsRegister] = useState(false);
        const [account, setAccount] = useState('');
        const [nickname, setNickname] = useState('');
        const [pin, setPin] = useState('');
        const [showPin, setShowPin] = useState(false);
        const [loading, setLoading] = useState(false);
        const [modal, setModal] = useState({ open: false });

        const showModal = (title, content, type='danger') => setModal(() => ({ open: true, title, content, type, onConfirm: () => setModal(p => ({ ...p, open: false })), confirmText: 'ç¢ºå®š', onCancel: () => setModal(p => ({ ...p, open: false })) })); // ä¿®æ­£ onCancel
        const closeModal = () => setModal(p => ({ ...p, open: false }));

        const handleAuth = async (e) => {
            e.preventDefault();
            if (pin.length !== 6 || !/^\d+$/.test(pin)) return showModal('æ ¼å¼éŒ¯èª¤', 'PIN ç¢¼å¿…é ˆæ˜¯ 6 ä½æ•¸å­—');
            if (!account.trim()) return showModal('æ ¼å¼éŒ¯èª¤', 'è«‹è¼¸å…¥å¸³è™Ÿ');
            if (isRegister && !nickname.trim()) return showModal('æ ¼å¼éŒ¯èª¤', 'è«‹è¼¸å…¥æ‚¨çš„æš±ç¨±');

            setLoading(true);
            const fakeEmail = `${account.trim()}@cube.local`;

            try {
                if (isRegister) {
                    const userCredential = await createUserWithEmailAndPassword(auth, fakeEmail, pin);
                    const user = userCredential.user;
                    await updateProfile(user, { displayName: nickname });
                    await setDoc(doc(db, 'users', user.uid), { nickname: nickname, account: account.trim(), createdAt: Date.now() });
                } else {
                    await signInWithEmailAndPassword(auth, fakeEmail, pin);
                }
            } catch (err) {
                let msg = err.message;
                if (err.code === 'auth/invalid-credential' || err.code === 'auth/wrong-password') msg = 'å¸³è™Ÿä¸å­˜åœ¨æˆ– PIN ç¢¼éŒ¯èª¤ã€‚';
                else if (err.code === 'auth/user-not-found') msg = 'æ‰¾ä¸åˆ°æ­¤å¸³è™Ÿï¼Œè«‹å…ˆè¨»å†Šã€‚';
                else if (err.code === 'auth/email-already-in-use') msg = 'æ­¤å¸³è™Ÿå·²è¢«è¨»å†Šï¼Œè«‹æ›´æ›ã€‚';
                showModal('ç™»å…¥å¤±æ•—', msg);
            }
            setLoading(false);
        };

        return (
            <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-gradient-to-br from-emerald-50 to-teal-50">
                <Modal {...modal} isOpen={modal.open} title={modal.title} content={modal.content} type={modal.type} onConfirm={modal.onConfirm} onCancel={closeModal} confirmText="ç¢ºå®š" />
                <div className="glass-card w-full max-w-sm p-8 relative overflow-hidden">
                    <div className="absolute top-0 right-0 -mt-16 -mr-16 w-48 h-48 bg-emerald-200/40 rounded-full blur-3xl"></div>
                    <div className="absolute bottom-0 left-0 -mb-16 -ml-16 w-48 h-48 bg-teal-200/40 rounded-full blur-3xl"></div>
                    <div className="relative z-10">
                        <div className="text-center mb-8">
                            <h1 className="text-2xl font-black text-emerald-800 tracking-tight leading-tight">åœ‹æ³°ä¸–è¯CUBEå¡<br/>LINE PAYå›é¥‹è¨ˆç®—å™¨</h1>
                        </div>
                        {isRegister && (
                            <div className="bg-amber-50 border border-amber-100 rounded-xl p-4 mb-6 text-xs text-amber-800 leading-relaxed">
                                <strong className="block mb-1 text-amber-900">âš ï¸ è¨»å†Šé ˆçŸ¥</strong>
                                é€™æ˜¯ç°¡æ˜“ç³»çµ±ï¼ŒPIN ç¢¼éºå¤±å°‡<b>ç„¡æ³•æ‰¾å›å¸³è™Ÿ</b>ã€‚
                            </div>
                        )}
                        <form onSubmit={handleAuth} className="space-y-4">
                            <div><label className="text-xs font-bold text-gray-500 uppercase ml-1 mb-1 block">å¸³è™Ÿ</label><input type="text" className="custom-input w-full rounded-xl p-3.5 text-gray-800 font-bold" value={account} onChange={e => setAccount(e.target.value)} /></div>
                            {isRegister && ( <div className="modal-anim"><label className="text-xs font-bold text-gray-500 uppercase ml-1 mb-1 block">æš±ç¨± (å¯éš¨æ™‚ä¿®æ”¹)</label><input type="text" className="custom-input w-full rounded-xl p-3.5 text-gray-800 font-bold" value={nickname} onChange={e => setNickname(e.target.value)} /></div> )}
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase ml-1 mb-1 block">6ä½æ•¸ PIN</label>
                                <div className="relative">
                                    <input type={showPin ? "tel" : "password"} inputMode="numeric" maxLength="6" className="custom-input w-full rounded-xl p-3.5 text-center font-mono text-xl tracking-widest text-gray-800" value={pin} onChange={e => { const val = e.target.value.replace(/\D/g, ''); if(val.length<=6) setPin(val); }} />
                                    <button type="button" onClick={() => setShowPin(!showPin)} className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-emerald-600 p-2 btn-touch">{showPin ? <Icons.EyeOff/> : <Icons.Eye/>}</button>
                                </div>
                            </div>
                            <button type="submit" disabled={loading} className="btn-primary btn-touch w-full py-4 rounded-xl font-bold text-lg mt-4 flex justify-center items-center">{loading ? <div className="loading-spinner border-white border-t-transparent"></div> : (isRegister ? 'ç«‹å³è¨»å†Š' : 'ç™»å…¥')}</button>
                        </form>
                        <div className="mt-8 text-center space-y-4">
                            <button onClick={() => { setIsRegister(!isRegister); setPin(''); setShowPin(false); }} className="text-sm font-bold text-gray-500 hover:text-emerald-600 transition btn-touch">{isRegister ? 'å·²æœ‰å¸³è™Ÿï¼Ÿè¿”å›ç™»å…¥' : 'ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Ÿå»ºç«‹æ–°å¸³è™Ÿ'}</button>
                            <div><button onClick={onShowPrivacy} className="text-xs text-gray-400 hover:text-gray-600 flex items-center justify-center gap-1 mx-auto btn-touch"><Icons.Shield/> éš±ç§æ¬Šæ”¿ç­–</button></div>
                        </div>
                    </div>
                </div>
            </div>
        );
    };

    const MainApp = ({ user, onLogout, onShowPrivacy }) => {
        const [transactions, setTransactions] = useState([]);
        const [currentMonth, setCurrentMonth] = useState(new Date().toISOString().substring(0, 7));
        const [form, setForm] = useState({ date: new Date().toISOString().substring(0, 10), merchant: '', amount: '', excluded: false });
        const [modal, setModal] = useState({ open: false, type: 'info', title: '', content: '' });
        const [showSettings, setShowSettings] = useState(false);
        const [currentNickname, setCurrentNickname] = useState(user.displayName || 'ä½¿ç”¨è€…');
        const canvasRef = useRef(null);

        useEffect(() => {
            const unsubUser = onSnapshot(doc(db, 'users', user.uid), (docSnap) => { if (docSnap.exists() && docSnap.data().nickname) setCurrentNickname(docSnap.data().nickname); });
            const q = query(collection(db, 'users', user.uid, 'records'), orderBy('date', 'desc'));
            const unsubTrans = onSnapshot(q, (snapshot) => { setTransactions(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); });
            return () => { unsubUser(); unsubTrans(); };
        }, [user]);

        const monthlyData = transactions.filter(t => t.date.startsWith(currentMonth));
        let _acc = 0;
        const _validCount = monthlyData.filter(t => !t.excluded).length;
        const _isQualified = _validCount >= 8;
        
        const processedList = [...monthlyData].sort((a,b)=>a.date.localeCompare(b.date)||a.createdAt-b.createdAt).map(t=>{
            let base=0, bonus=0, capped=false;
            if(!t.excluded) {
                base = Math.round(t.amount * 0.003);
                if(_isQualified) {
                    let raw = Math.round(t.amount * 0.017);
                    if(_acc < 100) { let rem = 100 - _acc; bonus = Math.min(raw, rem); if(raw > rem) capped = true; } else { capped = true; }
                    _acc += bonus;
                }
            }
            return { ...t, base, bonus, capped };
        }).reverse();

        const totalBase = processedList.reduce((acc, t) => acc + t.base, 0);
        const totalBonus = processedList.reduce((acc, t) => acc + t.bonus, 0);

        useEffect(() => {
            if (!canvasRef.current) return;
            const ctx = canvasRef.current.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            const rect = canvasRef.current.getBoundingClientRect();
            canvasRef.current.width = rect.width * dpr;
            canvasRef.current.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            const W = rect.width; const H = rect.height;
            ctx.clearRect(0,0,W,H);
            
            const drawRing = (x,y,cur,max,c,lbl,sub) => {
                ctx.beginPath(); ctx.arc(x,y,60,0,Math.PI*2); ctx.strokeStyle='#f3f4f6'; ctx.lineWidth=12; ctx.stroke();
                const pct = Math.min(cur/max,1);
                if(pct>0){ ctx.beginPath(); ctx.arc(x,y,60,-Math.PI/2,(-Math.PI/2)+(pct*Math.PI*2)); ctx.strokeStyle=c; ctx.lineWidth=12; ctx.lineCap='round'; ctx.stroke(); }
                ctx.fillStyle='#374151'; ctx.font='bold 36px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(cur,x,y-5);
                ctx.fillStyle='#9ca3af'; ctx.font='14px sans-serif'; ctx.fillText('/ '+max,x,y+28);
                ctx.fillStyle=c; ctx.font='bold 16px sans-serif'; ctx.fillText(lbl,x,y+85);
                ctx.fillStyle='#6b7280'; ctx.font='12px sans-serif'; ctx.fillText(sub,x,y+105);
            };
            drawRing(W*0.25, H/2-25, _validCount, 8, _isQualified?'#10b981':'#f59e0b', 'åˆæ ¼ç­†æ•¸', _isQualified?'å·²é”æ¨™':`é‚„å·® ${8-_validCount} ç­†`);
            drawRing(W*0.75, H/2-25, totalBonus, 100, totalBonus>=100?'#ef4444':'#10b981', 'åŠ ç¢¼é»æ•¸', totalBonus>=100?'å·²å°é ‚':'æœªå°é ‚');
            ctx.beginPath(); ctx.moveTo(W/2,20); ctx.lineTo(W/2,H-20); ctx.strokeStyle='#e5e7eb'; ctx.lineWidth=2; ctx.stroke();
        }, [transactions, currentMonth]);

        const showModal = (cfg) => setModal(() => ({ ...cfg, open: true }));
        const closeModal = () => setModal(p => ({ ...p, open: false }));

        const addTx = async () => {
            if (!form.merchant || !form.amount) return showModal({ title: 'ç¼ºè³‡æ–™', content: 'è«‹å¡«å¯«å•†å®¶èˆ‡é‡‘é¡', type: 'danger', confirmText: 'ç¢ºå®š', onConfirm: closeModal, onCancel: null });
            await addDoc(collection(db, 'users', user.uid, 'records'), { ...form, amount: parseInt(form.amount), createdAt: Date.now() });
            setForm({ ...form, merchant: '', amount: '', excluded: false });
        };
        const delTx = (id) => { showModal({ title: 'åˆªé™¤ç´€éŒ„', content: 'ç¢ºå®šè¦åˆªé™¤é€™ç­†äº¤æ˜“å—ï¼Ÿ', type: 'danger', confirmText: 'åˆªé™¤', cancelText:'å–æ¶ˆ', onConfirm: async () => { await deleteDoc(doc(db, 'users', user.uid, 'records', id)); closeModal(); }, onCancel: closeModal }); };
        
        const editTx = (tx) => {
            showModal({
                title: 'ç·¨è¼¯äº¤æ˜“ç´€éŒ„',
                type: 'editTransaction',
                editingData: tx,
                confirmText: 'å„²å­˜',
                cancelText: 'å–æ¶ˆ',
                onConfirm: async (newForm) => {
                    if (!newForm.merchant || !newForm.amount) return alert('è«‹å¡«å¯«å•†å®¶èˆ‡é‡‘é¡');
                    await updateDoc(doc(db, 'users', user.uid, 'records', tx.id), {
                        date: newForm.date,
                        merchant: newForm.merchant,
                        amount: newForm.amount,
                        excluded: newForm.excluded
                    });
                    closeModal();
                },
                onCancel: closeModal
            });
        };
        
        const changeNickname = () => { showModal({ title: 'ä¿®æ”¹æš±ç¨±', content: 'è«‹è¼¸å…¥æ–°çš„æš±ç¨±ï¼š', type: 'input', inputPlaceholder: currentNickname, inputValue: currentNickname, confirmText: 'å„²å­˜', cancelText:'å–æ¶ˆ', onConfirm: async (newVal) => { if(!newVal.trim()) return alert('æš±ç¨±ä¸èƒ½ç‚ºç©º'); await updateProfile(user, { displayName: newVal }); await setDoc(doc(db, 'users', user.uid), { nickname: newVal }, { merge: true }); closeModal(); }, onCancel: closeModal }); };
        const changePin = () => { showModal({ title: 'ä¿®æ”¹ PIN ç¢¼', type: 'changePin', confirmText: 'ç¢ºèªä¿®æ”¹', cancelText:'å–æ¶ˆ', onConfirm: async (oldPin, newPin) => { if(!oldPin || !newPin) return alert('è«‹è¼¸å…¥èˆŠ PIN èˆ‡æ–° PIN'); if(newPin.length !== 6) return alert('æ–° PIN ç¢¼å¿…é ˆæ˜¯ 6 ä½æ•¸å­—'); try { const credential = EmailAuthProvider.credential(user.email, oldPin); await reauthenticateWithCredential(user, credential); await updatePassword(user, newPin); closeModal(); showModal({ title: 'ä¿®æ”¹æˆåŠŸ', content: 'æ‚¨çš„ PIN ç¢¼å·²æ›´æ–°ã€‚', type: 'info', confirmText: 'ç¢ºå®š', onConfirm: closeModal }); } catch(e) { if(e.code === 'auth/invalid-credential' || e.code === 'auth/wrong-password') alert('èˆŠ PIN ç¢¼éŒ¯èª¤'); else alert('ä¿®æ”¹å¤±æ•—ï¼š' + e.message); throw e; } }, onCancel: closeModal }); };
        const clearData = () => { showModal({ title: 'æ¸…ç©ºè³‡æ–™', content: 'ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è¨˜å¸³ç´€éŒ„å—ï¼Ÿ', type: 'danger', confirmText: 'ç¢ºèªæ¸…ç©º', cancelText:'å–æ¶ˆ', onConfirm: async () => { const snapshot = await getDocs(query(collection(db, 'users', user.uid, 'records'))); await Promise.all(snapshot.docs.map(d => deleteDoc(d.ref))); closeModal(); }, onCancel: closeModal }); };
        const deleteAccount = () => { const accName = user.email.split('@')[0]; showModal({ title: 'åˆªé™¤å¸³è™Ÿ', content: 'è«‹è¼¸å…¥æ‚¨çš„å¸³è™Ÿåç¨±ä»¥ç¢ºèªåˆªé™¤ã€‚', type: 'input', inputPlaceholder: accName, confirmText: 'æ°¸ä¹…åˆªé™¤', cancelText:'å–æ¶ˆ', type: 'danger', onConfirm: async (val) => { if (val !== accName) return alert('å¸³è™Ÿåç¨±è¼¸å…¥éŒ¯èª¤'); try { const snapshot = await getDocs(query(collection(db, 'users', user.uid, 'records'))); await Promise.all(snapshot.docs.map(d => deleteDoc(d.ref))); await deleteDoc(doc(db, 'users', user.uid)); await deleteUser(user); } catch (e) { alert('åˆªé™¤å¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥å¾Œå†è©¦'); } }, onCancel: closeModal }); };

        const monthOptions = [...new Set(transactions.map(t=>t.date.substring(0,7))), new Date().toISOString().substring(0,7)].sort().reverse();

        return (
            <div className="container mx-auto max-w-2xl p-4 pb-24">
                <Modal {...modal} onCancel={closeModal} />
                <div className="flex justify-between items-center mb-6 pl-2">
                    <div className="text-2xl font-black text-gray-800 tracking-tight">{currentNickname}ï¼Œæ‚¨å¥½ï¼</div>
                    <div className="flex gap-2">
                        <button onClick={() => setShowSettings(!showSettings)} className={`p-2.5 rounded-full btn-touch transition relative z-50 ${showSettings ? 'bg-emerald-100 text-emerald-600' : 'bg-white text-gray-400 shadow-sm border border-gray-100'}`}><Icons.Settings/></button>
                        <button onClick={onLogout} className="px-5 py-2 bg-white text-emerald-600 text-sm font-bold rounded-full shadow-sm border border-emerald-100 btn-touch">ç™»å‡º</button>
                    </div>
                </div>

                {showSettings && (
                    <div className="app-card p-4 mb-6 modal-anim border-l-4 border-emerald-500 relative z-50">
                        <h3 className="font-bold text-gray-700 mb-3 ml-1">è¨­å®šèˆ‡éš±ç§</h3>
                        <div className="space-y-2">
                            {/* ä¿®æ­£ï¼šç¢ºä¿é»æ“Šæ™‚setShowSettings(false)ä¸¦èª¿ç”¨showModal */}
                            <button onClick={() => { changeNickname(); setShowSettings(false); }} className="w-full text-left px-4 py-3 bg-gray-50 rounded-xl text-sm font-bold text-gray-600 hover:bg-emerald-50 flex items-center gap-2 btn-touch border border-transparent hover:border-emerald-100"><span className="p-1 bg-emerald-100 rounded-lg text-emerald-600"><Icons.Edit/></span> ä¿®æ”¹æš±ç¨±</button>
                            <button onClick={() => { changePin(); setShowSettings(false); }} className="w-full text-left px-4 py-3 bg-gray-50 rounded-xl text-sm font-bold text-gray-600 hover:bg-violet-50 flex items-center gap-2 btn-touch border border-transparent hover:border-violet-100"><span className="p-1 bg-violet-100 rounded-lg text-violet-600"><Icons.Key/></span> ä¿®æ”¹ PIN ç¢¼</button>
                            <button onClick={() => { onShowPrivacy(); setShowSettings(false); }} className="w-full text-left px-4 py-3 bg-gray-50 rounded-xl text-sm font-bold text-gray-600 hover:bg-gray-100 flex items-center gap-2 btn-touch border border-transparent hover:border-gray-200"><span className="p-1 bg-gray-200 rounded-lg text-gray-500"><Icons.Shield/></span> æŸ¥çœ‹éš±ç§æ¬Šæ”¿ç­–</button>
                            <div className="grid grid-cols-2 gap-2 pt-2">
                                <button onClick={() => { clearData(); setShowSettings(false); }} className="px-4 py-3 bg-amber-50 text-amber-600 rounded-xl text-sm font-bold hover:bg-amber-100 btn-touch">æ¸…é™¤è³‡æ–™</button>
                                <button onClick={() => { deleteAccount(); setShowSettings(false); }} className="px-4 py-3 bg-red-50 text-red-600 rounded-xl text-sm font-bold hover:bg-red-100 btn-touch">åˆªé™¤å¸³è™Ÿ</button>
                            </div>
                        </div>
                    </div>
                )}
                
                <div className="app-card p-4 mb-4 flex justify-center">
                    <canvas ref={canvasRef} style={{width: '100%', maxWidth: '500px'}} height={240} className="w-full h-auto"></canvas>
                </div>
                
                <div className="flex justify-between items-end mb-4 px-2">
                    <select value={currentMonth} onChange={e=>setCurrentMonth(e.target.value)} className="bg-white border-none py-2 px-4 rounded-xl shadow-sm text-lg font-bold text-gray-700 outline-none">{monthOptions.map(m=><option key={m} value={m}>{m}</option>)}</select>
                    <div className="text-right">
                        <div className="text-sm text-gray-500 font-bold mb-1">æœ¬æœˆé ä¼°å›é¥‹</div>
                        <div className="flex items-baseline justify-end gap-2">
                            <div className="text-xs font-bold text-gray-400">åŸºæœ¬ 0.3%: <span className="text-gray-600">{totalBase}</span></div>
                            <div className="text-xs font-bold text-emerald-500">åŠ ç¢¼ 1.7%: <span className="text-emerald-700 text-lg">{totalBonus}</span></div>
                        </div>
                        <div className="text-[10px] text-gray-400 mt-1">*åŠ ç¢¼å›é¥‹é è¨ˆæ–¼æ¬¡æ¬¡æœˆå…¥å¸³</div>
                    </div>
                </div>

                <div className="app-card p-5 mb-6">
                    <div className="flex flex-col gap-4 mb-4 md:grid md:grid-cols-12 md:gap-3">
                        <div className="md:col-span-4"><label className="text-xs font-bold text-gray-400 ml-1 mb-1 block">æ—¥æœŸ</label><input type="date" className="custom-input w-full p-2.5 rounded-xl h-[46px]" value={form.date} onChange={e=>setForm({...form, date:e.target.value})} /></div>
                        <div className="md:col-span-5"><label className="text-xs font-bold text-gray-400 ml-1 mb-1 block">å•†å®¶</label><input type="text" className="custom-input w-full p-2.5 rounded-xl h-[46px]" placeholder="å•†å®¶" value={form.merchant} onChange={e=>setForm({...form, merchant:e.target.value})} /></div>
                        <div className="md:col-span-3"><label className="text-xs font-bold text-gray-400 ml-1 mb-1 block">é‡‘é¡</label><input type="number" className="custom-input w-full p-2.5 rounded-xl h-[46px]" placeholder="$" value={form.amount} onChange={e=>setForm({...form, amount:e.target.value})} /></div>
                    </div>
                    <div className="flex justify-between items-center">
                        <label className="flex items-center text-sm text-gray-600 font-bold cursor-pointer select-none"><input type="checkbox" className="mr-2 w-5 h-5 accent-emerald-600 rounded" checked={form.excluded} onChange={e=>setForm({...form, excluded:e.target.checked})} />éä¸€èˆ¬æ¶ˆè²»</label>
                        <button onClick={addTx} className="btn-primary btn-touch px-8 py-2.5 rounded-xl font-bold text-white shadow-lg shadow-emerald-200">æ–°å¢</button>
                    </div>
                </div>

                <div className="space-y-3">
                    {processedList.length===0 ? <div className="text-center p-8 text-gray-400">å°šç„¡è³‡æ–™</div> : processedList.map(t=>(
                        <div key={t.id} className={`app-card p-4 flex justify-between items-center ${t.excluded ? 'opacity-60 bg-gray-50' : ''}`}>
                            <div className="flex-1 min-w-0">
                                {/* æ—¥æœŸæ ¼å¼ï¼šyyyy/mm/dd */}
                                <div className="text-xs text-gray-400 mb-0.5">{t.date.replace(/-/g, '/')}</div>
                                <div className="font-bold text-gray-800 text-lg truncate">{t.merchant}</div>
                                {t.excluded && <span className="text-[10px] bg-gray-200 px-1.5 py-0.5 rounded text-gray-500">æ’é™¤è¨ˆç®—</span>}
                            </div>
                            <div className="text-right flex flex-col items-end mr-4 min-w-[120px]">
                                <div className="text-xl font-mono font-bold text-gray-700 mb-1">${t.amount}</div>
                                {!t.excluded && (
                                    <div className="flex gap-1.5">
                                        <span className="badge badge-base">åŸº {t.base}</span>
                                        <span className={`badge ${t.capped ? 'badge-capped' : 'badge-bonus'}`}>åŠ  {t.bonus}</span>
                                    </div>
                                )}
                            </div>
                            <div className="flex flex-col gap-1">
                                <button onClick={()=>editTx(t)} className="p-2 text-gray-400 hover:text-blue-500 transition btn-touch bg-gray-50 rounded-full"><Icons.Edit/></button>
                                <button onClick={()=>delTx(t.id)} className="p-2 text-gray-300 hover:text-red-500 transition btn-touch bg-gray-50 rounded-full"><Icons.Trash/></button>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        );
    };

    const App = () => {
        const [user, setUser] = useState(null);
        const [init, setInit] = useState(true);
        const [privacyOpen, setPrivacyOpen] = useState(false);
        useEffect(() => onAuthStateChanged(auth, (u) => { setUser(u); setInit(false); }), []);
        if (init) return <div className="min-h-screen flex items-center justify-center"><div className="loading-spinner w-10 h-10 border-4"></div></div>;
        return (
            <>
                <Modal isOpen={privacyOpen} title="éš±ç§æ¬Šæ”¿ç­–" content={<PrivacyPolicyContent/>} onConfirm={()=>setPrivacyOpen(false)} confirmText="æˆ‘ç­è§£äº†" type="info" />
                {user ? <MainApp user={user} onLogout={()=>signOut(auth)} onShowPrivacy={()=>setPrivacyOpen(true)} /> : <AuthScreen onShowPrivacy={()=>setPrivacyOpen(true)} />}
            </>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>